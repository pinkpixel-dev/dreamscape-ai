<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Dreamscape AI - Utility Tools</title>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Quicksand:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="css/enhance.css">
    <link rel="stylesheet" href="css/cloudinary.css">
    <link rel="icon" type="image/png" href="../favicon.png">
    <!-- Add Cloudinary SDK directly -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/url-polyfill/1.1.12/url-polyfill.min.js"></script>
    
    <!-- Check Cloudinary loading -->
    <script>
        console.log("Cloudinary script check:", typeof window.cloudinary);
        if (!window.cloudinary) {
            console.error("Cloudinary failed to load! Adding again...");
            // Try to load it again
            const script = document.createElement('script');
            script.src = "https://upload-widget.cloudinary.com/global/all.js";
            script.type = "text/javascript";
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        :root {
            --primary-color: #9d4edd;
            --primary-dark: #7b2cbf;
            --background-dark: #19031b;  
            --background-darker: #0c021b; 
            --text-light: #c8cdf1;
            --text-white: #ffffff;
            --accent-color: #5a2d88;
            --border-color: rgba(157, 78, 221, 0.2);
            --card-bg: rgba(157, 78, 221, 0.05);
            --sidebar-bg: rgba(30, 30, 30, 0.95);
        }
        
        /* Background and animation styles - copied exactly from enhance.html */
        .stars {
            width: 100%;
            height: 100%;
            position: fixed;
            background: transparent url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png") repeat;
            background-size: 1000px 1000px;
            opacity: 0.6;
            mix-blend-mode: screen;
            z-index: 0;
        }

        .twinkling {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: transparent;
            overflow: hidden;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        .clouds {
            width: 10000px;
            height: 100%;
            position: fixed;
            background: transparent url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/clouds_repeat.png") repeat;
            background-size: 4000px 4000px;
            z-index: 2;
            opacity: 0.4;
            animation: move-background 150s linear infinite;
        }

        @keyframes move-background {
            from {
                transform: translate3d(0px, 0px, 0px);
            }
            to { 
                transform: translate3d(-4000px, 0px, 0px);
            }
        }

        /* Critical fixes for the white background issue - these will override any other styles */
        .image-holder {
            background-color: rgba(0, 0, 0, 0.3) !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .image-holder::after {
            content: '' !important;
            position: absolute !important;
            inset: 0 !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            z-index: -1 !important;
            pointer-events: none !important;
        }
        
        .image-holder img {
            background-color: transparent !important;
            position: relative !important;
            z-index: 2 !important;
        }
        
        /* Critical fix for image containers */
        #original-image-display, #processed-image-display, #bg-original-display, #bg-removed-display {
            background-color: rgba(0, 0, 0, 0.3) !important;
        }

        /* Add these rules at the bottom of your style section to overwrite all others */
        .result-container, 
        .image-comparison, 
        .original-image, 
        .enhanced-image {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }

        .original-image h3, 
        .enhanced-image h3 {
            color: white !important;
        }

        .image-holder {
            background-color: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 8px !important;
        }

        .image-holder img {
            background-color: transparent !important;
            max-height: 400px !important;
        }
        
        /* Ensure stars background is properly displayed */
        .stars {
            width: 100%;
            height: 100%;
            position: fixed;
            background: transparent url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png") repeat;
            background-size: 1000px 1000px;
            opacity: 0.6;
            mix-blend-mode: screen;
            z-index: 0;
        }

        .twinkling {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: transparent;
            overflow: hidden;
            pointer-events: none;
            top: 0;
            left: 0;
        }
        
        /* Critical fixes for placeholders and image containers */
        .image-holder {
            background-color: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 8px !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .image-holder img {
            max-width: 100% !important;
            max-height: 400px !important;
            object-fit: contain !important;
            background-color: transparent !important;
            display: block !important;
            margin: 0 auto !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .placeholder {
            background-color: rgba(0, 0, 0, 0.3) !important;
            color: white !important;
            padding: 20px !important;
            border-radius: 8px !important;
            text-align: center !important;
            width: 100% !important;
            height: 100% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        /* Ensure image display containers maintain styles */
        #original-image-display, #processed-image-display {
            min-height: 300px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            overflow: hidden !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
        }
        
        /* Result container styles */
        .result-container, 
        .image-comparison, 
        .original-image, 
        .processed-image {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Loading spinner animation */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Progress bar styling */
        .progress-container {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: white;
        }
        
        .progress-bar-container {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            overflow: hidden;
            height: 8px;
        }
        
        #utility-progress-bar {
            height: 100%;
            background: linear-gradient(to right, #7b2cbf, #9d4edd);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div class="twinkling"></div>
    <div class="clouds"></div>
    <div class="moon-container">
        <img class="moon-img" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/moon2.png" alt="moon">
    </div>
    
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../favicon.png" alt="Dreamscape AI" class="sidebar-logo">
                <span>Creative Studio‚ú®</span>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">üìã Navigation</p>
                <a href="../index.html" class="nav-link">üè† Home</a>
                <a href="enhance.html" class="nav-link">‚ú® Enhance Images</a>
                <a href="artistic.html" class="nav-link">üé® Artistic Effects</a>
                <a href="utility.html" class="nav-link active">üõ†Ô∏è Utility Tools</a>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">üîß Tool Type</p>
                <div class="control-group">
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="tool-type" value="resize" checked>
                            üìè Resize
                        </label>
                        <label>
                            <input type="radio" name="tool-type" value="crop">
                            ‚úÇÔ∏è Crop
                        </label>
                        <label>
                            <input type="radio" name="tool-type" value="background">
                            üñºÔ∏è Background Removal
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section" id="resize-controls">
                <p class="section-title">üìè Resize Settings</p>
                <div class="control-group">
                    <label for="resize-mode">Resize Mode</label>
                    <select id="resize-mode">
                        <option value="scale">Scale (Change dimensions)</option>
                        <option value="fit">Fit (Preserve aspect ratio)</option>
                        <option value="fill">Fill (Cover area, may crop)</option>
                        <option value="pad">Pad (Add padding if needed)</option>
                        <option value="limit">Limit (Down-scale only)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="output-size-type">Sizing Method</label>
                    <select id="output-size-type">
                        <option value="original">Original Size</option>
                        <option value="custom" selected>Custom Size</option>
                        <option value="preset">Preset Dimensions</option>
                    </select>
                </div>
                
                <!-- Custom width and height sliders -->
                <div id="custom-size-controls">
                    <div class="control-group slider-control">
                        <label for="width-control">Width <span>768</span>px</label>
                        <input type="range" id="width-control" min="100" max="2000" value="768">
                    </div>
                    <div class="control-group slider-control">
                        <label for="height-control">Height <span>768</span>px</label>
                        <input type="range" id="height-control" min="100" max="2000" value="768">
                    </div>
                    <div class="control-group">
                        <label for="maintain-aspect-ratio">
                            <input type="checkbox" id="maintain-aspect-ratio" checked>
                            üîí Maintain Aspect Ratio
                        </label>
                    </div>
                </div>
                
                <!-- Preset dimensions dropdown, hidden initially if custom is selected -->
                <div id="preset-size-controls" style="display: none;">
                    <div class="control-group">
                        <label for="output-size">Preset Dimensions</label>
                        <select id="output-size">
                            <option value="512x512">512 x 512</option>
                            <option value="768x768" selected>768 x 768</option>
                            <option value="1024x1024">1024 x 1024</option>
                            <option value="1280x720">1280 x 720 (HD)</option>
                            <option value="1920x1080">1920 x 1080 (Full HD)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section" id="crop-controls" style="display: none;">
                <p class="section-title">‚úÇÔ∏è Crop Settings</p>
                <div class="control-group">
                    <label for="crop-mode">Crop Mode</label>
                    <select id="crop-mode">
                        <option value="custom">Custom Crop (Draggable)</option>
                        <option value="fill">Auto Fill</option>
                        <option value="lfill">Auto Fill from Left</option>
                        <option value="fill_pad">Fill with Padding</option>
                        <option value="crop">Simple Crop</option>
                        <option value="thumb">Thumbnail</option>
                    </select>
                </div>
                <div class="control-group" id="gravity-group">
                    <label for="gravity">Gravity (Focus Area)</label>
                    <select id="gravity">
                        <option value="auto">Auto (AI Detection)</option>
                        <option value="face">Face Detection</option>
                        <option value="faces">Multiple Faces</option>
                        <option value="center">Center</option>
                        <option value="north">Top</option>
                        <option value="south">Bottom</option>
                        <option value="east">Right</option>
                        <option value="west">Left</option>
                        <option value="north_east">Top Right</option>
                        <option value="north_west">Top Left</option>
                        <option value="south_east">Bottom Right</option>
                        <option value="south_west">Bottom Left</option>
                    </select>
                </div>
                <div class="control-group" id="custom-crop-controls">
                    <div id="crop-dimensions-info">
                        <p>X: <span id="crop-x">0</span> Y: <span id="crop-y">0</span></p>
                        <p>Width: <span id="crop-width">0</span> Height: <span id="crop-height">0</span></p>
                    </div>
                    <p class="crop-instructions">Drag to create your crop area after uploading an image.</p>
                </div>
            </div>
            
            <div class="sidebar-section" id="background-controls" style="display: none;">
                <p class="section-title">üñºÔ∏è Background Options</p>
                <div class="control-group">
                    <label for="remove-background">
                        <input type="checkbox" id="remove-background" checked>
                        üîÑ Remove Background
                    </label>
                </div>
                <div class="control-group">
                    <label for="transparency">
                        <input type="checkbox" id="transparency" checked>
                        üîç Keep Transparency
                    </label>
                </div>
                <div class="control-group">
                    <label for="background-replacement">Background Replacement</label>
                    <select id="background-replacement">
                        <option value="none">None (Transparent)</option>
                        <option value="color">Solid Color</option>
                        <option value="gradient">Gradient</option>
                        <option value="image">Custom Image</option>
                    </select>
                </div>
                <div class="control-group" id="bg-color-control" style="display: none;">
                    <label for="bg-color">Background Color</label>
                    <input type="color" id="bg-color" value="#ffffff">
                </div>
                <div class="control-group" id="bg-gradient-control" style="display: none;">
                    <label for="gradient-start">Gradient Start</label>
                    <input type="color" id="gradient-start" value="#9d4edd">
                    <label for="gradient-end">Gradient End</label>
                    <input type="color" id="gradient-end" value="#3a0ca3">
                </div>
                <div class="control-group" id="bg-image-control" style="display: none;">
                    <button id="bg-image-upload" class="action-button">Upload Background Image</button>
                    <input type="file" id="bg-image-input" accept="image/*" style="display: none;">
                    <div id="bg-image-preview" style="margin-top: 10px; display: none;"></div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">üõ†Ô∏è Settings</p>
                <div class="control-group">
                    <label for="remove-watermark">
                        <input type="checkbox" id="remove-watermark" checked>
                        üéØ Remove Watermark
                    </label>
                </div>
                <div class="control-group">
                    <label for="optimize-quality">
                        <input type="checkbox" id="optimize-quality" checked>
                        ‚öôÔ∏è Optimize Quality
                    </label>
                </div>
                <div class="control-group">
                    <label for="output-format">Output Format</label>
                    <select id="output-format">
                        <option value="auto">Auto (Best Format)</option>
                        <option value="jpg">JPG (Smaller Size)</option>
                        <option value="png">PNG (Better Quality)</option>
                        <option value="webp">WebP (Modern Browsers)</option>
                    </select>
                </div>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">‚ÑπÔ∏è About</p>
                <div class="control-group enhance-description">
                    <p>This tool provides essential image utilities using Cloudinary's API. Resize, crop, or remove backgrounds from your images with precision.</p>
                    <p>Your images are processed securely and are not stored on our servers.</p>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="title-container">
                <div class="title-wrapper">
                    <h1>Utility Tools üõ†Ô∏è</h1>
                </div>
                <p class="subtitle-text">Essential image editing tools for your projects</p>
            </div>
            
            <div class="content-area">
                <div class="upload-area" id="upload-area">
                    <div id="upload-content">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Drag & Drop an Image</h3>
                        <p>or click to browse</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="result-container" id="result-container" style="display: none;">
                    <div class="tool-interface">
                        <!-- This container will be populated based on the selected tool -->
                        <div id="resize-interface" class="image-comparison">
                            <div class="original-image">
                                <h3>Original Image</h3>
                                <div class="image-holder" id="original-image-display"></div>
                                <div class="image-info" id="original-dimensions"></div>
                            </div>
                            <div class="enhanced-image">
                                <h3>Resized Image</h3>
                                <div class="image-holder" id="processed-image-display"></div>
                                <div class="image-info" id="new-dimensions"></div>
                            </div>
                        </div>
                        
                        <div id="crop-interface" style="display: none;">
                            <h3>Drag to Create Crop Selection</h3>
                            <div class="crop-container" id="crop-container">
                                <img id="crop-image" class="crop-image" src="" alt="Image for cropping">
                                <div class="crop-overlay"></div>
                                <div class="crop-selection" style="display: none;"></div>
                            </div>
                            <div class="aspect-ratio-selector" id="aspect-ratio-buttons">
                                <div class="aspect-ratio-option selected" data-ratio="free">Free</div>
                                <div class="aspect-ratio-option" data-ratio="1:1">1:1</div>
                                <div class="aspect-ratio-option" data-ratio="16:9">16:9</div>
                                <div class="aspect-ratio-option" data-ratio="9:16">9:16</div>
                                <div class="aspect-ratio-option" data-ratio="4:3">4:3</div>
                                <div class="aspect-ratio-option" data-ratio="3:2">3:2</div>
                            </div>
                        </div>
                        
                        <div id="background-interface" style="display: none;">
                            <div class="image-comparison">
                                <div class="original-image">
                                    <h3>Original Image</h3>
                                    <div class="image-holder" id="bg-original-display"></div>
                                </div>
                                <div class="enhanced-image">
                                    <h3>Background Removed</h3>
                                    <div class="image-holder" id="bg-removed-display"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="apply-button" class="action-button">üîÑ Process Image</button>
                        <button id="download-button" class="action-button" disabled>üíæ Download Result</button>
                        <button id="reset-button" class="action-button">üîô Reset</button>
                    </div>
                    
                    <!-- Add progress bar container -->
                    <div class="progress-container" style="margin-top: 20px; display: none;">
                        <div class="progress-info">
                            <span id="utility-progress-text">Processing...</span>
                            <span id="utility-progress-percent">0%</span>
                        </div>
                        <div class="progress-bar-container" style="width: 100%; height: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden; margin-top: 5px;">
                            <div id="utility-progress-bar" style="width: 0%; height: 100%; background: linear-gradient(to right, #7b2cbf, #9d4edd); transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/cloudinary-api.js"></script>
    <script>
        // Basic JavaScript for star animation
        function createStars() {
            const container = document.querySelector('.twinkling');
            // Clear any existing stars
            container.innerHTML = '';
            
            // Create 500 stars
            for (let i = 0; i < 500; i++) {
                createTwinklingStar(container);
            }
            
            // Start shooting stars
            createShootingStars(container);
        }

        function createTwinklingStar(container) {
            const star = document.createElement('div');
            star.className = 'star';
            
            // Use a weighted distribution for star sizes
            const random = Math.random();
            if (random < 0.6) {
                star.classList.add('star-1'); // 60% small stars
            } else if (random < 0.8) {
                star.classList.add('star-2'); // 20% medium stars
            } else if (random < 0.95) {
                star.classList.add('star-3'); // 15% large stars
            } else {
                star.classList.add('star-4'); // 5% extra large stars
            }
            
            // Random position
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            
            // Random animation delay
            star.style.animationDelay = `${Math.random() * 5}s`;
            
            // Random animation duration between 3-8 seconds
            star.style.animationDuration = `${3 + Math.random() * 5}s`;
            
            container.appendChild(star);
            return star;
        }

        function createShootingStars(container) {
            // Create a shooting star every 8 seconds
            setInterval(() => {
                createShootingStar(container);
            }, 8000);
            
            // Create initial shooting star
            createShootingStar(container);
        }

        function createShootingStar(container) {
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            
            // Random position at the top edge of the screen
            const left = Math.random() * 100;
            shootingStar.style.left = `${left}%`;
            shootingStar.style.top = `${Math.random() * 30}%`;
            
            container.appendChild(shootingStar);
            
            // Remove the shooting star after the animation
            setTimeout(() => {
                shootingStar.remove();
            }, 3000);
        }
        
        // Tool type radio buttons
        const toolTypes = document.querySelectorAll('input[name="tool-type"]');
        const resizeControls = document.getElementById('resize-controls');
        const cropControls = document.getElementById('crop-controls');
        const backgroundControls = document.getElementById('background-controls');
        
        // Tool interfaces
        const resizeInterface = document.getElementById('resize-interface');
        const cropInterface = document.getElementById('crop-interface');
        const backgroundInterface = document.getElementById('background-interface');
        
        toolTypes.forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide all control sections
                resizeControls.style.display = 'none';
                cropControls.style.display = 'none';
                backgroundControls.style.display = 'none';
                
                // Hide all interfaces
                resizeInterface.style.display = 'none';
                cropInterface.style.display = 'none';
                backgroundInterface.style.display = 'none';
                
                // Show the selected section
                if (this.value === 'resize') {
                    resizeControls.style.display = 'block';
                    resizeInterface.style.display = 'flex';
                } else if (this.value === 'crop') {
                    cropControls.style.display = 'block';
                    cropInterface.style.display = 'block';
                } else if (this.value === 'background') {
                    backgroundControls.style.display = 'block';
                    backgroundInterface.style.display = 'block';
                }
            });
        });

        // Update slider value displays
        const sliders = document.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => {
            slider.addEventListener('input', function() {
                const valueDisplay = this.previousElementSibling.querySelector('span');
                valueDisplay.textContent = this.value;
            });
        });
        
        // Background replacement options
        const backgroundReplacement = document.getElementById('background-replacement');
        const bgColorControl = document.getElementById('bg-color-control');
        const bgGradientControl = document.getElementById('bg-gradient-control');
        const bgImageControl = document.getElementById('bg-image-control');
        
        backgroundReplacement.addEventListener('change', function() {
            bgColorControl.style.display = 'none';
            bgGradientControl.style.display = 'none';
            bgImageControl.style.display = 'none';
            
            if (this.value === 'color') {
                bgColorControl.style.display = 'block';
            } else if (this.value === 'gradient') {
                bgGradientControl.style.display = 'block';
            } else if (this.value === 'image') {
                bgImageControl.style.display = 'block';
            }
        });
        
        // Background image upload button
        const bgImageUpload = document.getElementById('bg-image-upload');
        const bgImageInput = document.getElementById('bg-image-input');
        const bgImagePreview = document.getElementById('bg-image-preview');
        
        bgImageUpload.addEventListener('click', () => {
            bgImageInput.click();
        });
        
        bgImageInput.addEventListener('change', () => {
            if (bgImageInput.files.length > 0) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    bgImagePreview.style.display = 'block';
                    bgImagePreview.innerHTML = `<img src="${e.target.result}" alt="Background Image" style="max-width: 100%; max-height: 100px; border-radius: 5px;">`;
                    
                    // Store the file for upload later
                    window.customBgFile = bgImageInput.files[0];
                };
                
                reader.readAsDataURL(bgImageInput.files[0]);
            }
        });
        
        // Size controls interaction
        const sizeTypeSelector = document.getElementById('output-size-type');
        const customSizeControls = document.getElementById('custom-size-controls');
        const presetSizeControls = document.getElementById('preset-size-controls');
        
        sizeTypeSelector.addEventListener('change', function() {
            if (this.value === 'custom') {
                customSizeControls.style.display = 'block';
                presetSizeControls.style.display = 'none';
            } else if (this.value === 'preset') {
                customSizeControls.style.display = 'none';
                presetSizeControls.style.display = 'block';
            } else {
                // Original size
                customSizeControls.style.display = 'none';
                presetSizeControls.style.display = 'none';
            }
        });
        
        // Setup aspect ratio maintenance
        const widthControl = document.getElementById('width-control');
        const heightControl = document.getElementById('height-control');
        const aspectRatioCheckbox = document.getElementById('maintain-aspect-ratio');
        
        let aspectRatio = 1; // Default square
        let isUpdatingWidth = false;
        let isUpdatingHeight = false;
        
        // Set initial aspect ratio from the original image once uploaded
        const updateAspectRatioFromImage = () => {
            if (uploadedImageInfo && uploadedImageInfo.width && uploadedImageInfo.height) {
                aspectRatio = uploadedImageInfo.width / uploadedImageInfo.height;
                console.log(`Set aspect ratio to ${aspectRatio} from original image`);
            }
        };
        
        // Width change handler
        widthControl.addEventListener('input', function() {
            if (isUpdatingWidth) return; // Prevent recursion
            
            const width = parseInt(this.value);
            widthControl.previousElementSibling.querySelector('span').textContent = width;
            
            // Update height based on aspect ratio if checkbox is checked
            if (aspectRatioCheckbox.checked && !isUpdatingHeight) {
                isUpdatingHeight = true;
                const newHeight = Math.round(width / aspectRatio);
                
                // Ensure height is within valid range
                const constrainedHeight = Math.min(Math.max(newHeight, 100), 2000);
                heightControl.value = constrainedHeight;
                heightControl.previousElementSibling.querySelector('span').textContent = constrainedHeight;
                isUpdatingHeight = false;
            }
        });
        
        // Height change handler
        heightControl.addEventListener('input', function() {
            if (isUpdatingHeight) return; // Prevent recursion
            
            const height = parseInt(this.value);
            heightControl.previousElementSibling.querySelector('span').textContent = height;
            
            // Update width based on aspect ratio if checkbox is checked
            if (aspectRatioCheckbox.checked && !isUpdatingWidth) {
                isUpdatingWidth = true;
                const newWidth = Math.round(height * aspectRatio);
                
                // Ensure width is within valid range
                const constrainedWidth = Math.min(Math.max(newWidth, 100), 2000);
                widthControl.value = constrainedWidth;
                widthControl.previousElementSibling.querySelector('span').textContent = constrainedWidth;
                isUpdatingWidth = false;
            }
        });
        
        // Variables to store image information
        let uploadedImageInfo = null; // Store the complete Cloudinary upload response
        let transformedImageUrl = '';  // Store the transformed image URL
        
        // File upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const resultContainer = document.getElementById('result-container');
        const originalImageDisplay = document.getElementById('original-image-display');
        const processedImageDisplay = document.getElementById('processed-image-display');
        const applyButton = document.getElementById('apply-button');
        const downloadButton = document.getElementById('download-button');
        const resetButton = document.getElementById('reset-button');
        
        // Configure the Cloudinary upload widget once
        const uploadWidget = window.cloudinary.createUploadWidget({
            cloudName: 'dwa9nkpyq',
            uploadPreset: 'dreamscape-unsigned',
            apiKey: '887549877845179',
            sources: ['local', 'url', 'camera', 'google_drive', 'facebook', 'dropbox', 'instagram'],
            showAdvancedOptions: false,
            cropping: false,
            multiple: false,
            defaultSource: 'local',
            folder: 'dreamscape-app',
            clientAllowedFormats: ['png', 'jpg', 'jpeg', 'gif', 'webp'],
            maxFileSize: 10000000,
            singleUploadAutoClose: true,
            styles: {
                palette: {
                    window: '#121212',
                    sourceBg: '#121212',
                    windowBorder: '#382f79',
                    tabIcon: '#ffffcc',
                    inactiveTabIcon: '#5e5e5e',
                    menuIcons: '#a76fef',
                    link: '#7046e8',
                    action: '#7046e8',
                    inProgress: '#7046e8',
                    complete: '#a76fef',
                    error: '#ff5a00',
                    textDark: '#eeeeee',
                    textLight: '#121212'
                },
                fonts: {
                    default: null,
                    "sans-serif": { url: null, active: true }
                }
            }
        }, (error, result) => {
            if (error) {
                console.error("Widget error:", error);
                showError('Upload failed: ' + (error.message || "Unknown error"));
                return;
            }
            
            if (result.event === "success") {
                console.log("Upload successful!", result.info);
                
                // Store the complete upload result for later transformation
                uploadedImageInfo = result.info;
                
                // Set aspect ratio from image
                updateAspectRatioFromImage();
                
                // Display the original image in the UI
                const originalUrl = result.info.secure_url;
                originalImageDisplay.innerHTML = `<img src="${originalUrl}" alt="Original Image">`;
                processedImageDisplay.innerHTML = `<div class="placeholder">Select utility options and click "Process Image"</div>`;
                
                // Update crop image display if needed
                const cropImage = document.getElementById('crop-image');
                if (cropImage) {
                    cropImage.src = originalUrl;
                }
                
                // Update background image displays if needed
                const bgOriginalDisplay = document.getElementById('bg-original-display');
                if (bgOriginalDisplay) {
                    bgOriginalDisplay.innerHTML = `<img src="${originalUrl}" alt="Original Image">`;
                }
                
                // Update dimensions display
                const originalDimensions = document.getElementById('original-dimensions');
                if (originalDimensions) {
                    originalDimensions.textContent = `${result.info.width} √ó ${result.info.height} pixels`;
                }
                
                // Show the result container, hide upload area
                uploadArea.style.display = 'none';
                resultContainer.style.display = 'block';
                
                // Enable the process button
                applyButton.disabled = false;
            } else if (result.event === "close") {
                // Only show message if nothing was uploaded
                if (!uploadedImageInfo) {
                    console.log("Widget closed without uploading");
                }
            }
        });
        
        // Replace drag-and-drop with direct widget trigger
        uploadArea.addEventListener('click', () => {
            uploadWidget.open();
        });
        
        // Also allow drag-and-drop to open the widget
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Instead of handling file directly, just open the widget
            uploadWidget.open();
        });
        
        // Apply utility transformations
        applyButton.addEventListener('click', async () => {
            console.log("Apply button clicked");
            
            if (!uploadedImageInfo) {
                showError('Please upload an image first');
                return;
            }
            
            // Disable button while processing
            applyButton.disabled = true;
            applyButton.textContent = "‚è≥ Processing...";
            
            // Show processing indicator
            processedImageDisplay.innerHTML = `
                <div class="placeholder">
                    <p>‚è≥ Processing image...</p>
                    <div class="progress-bar" style="width: 300px; height: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; margin: 20px auto;">
                        <div class="progress" style="width: 0%; height: 100%; background: linear-gradient(to right, #7b2cbf, #9d4edd); transition: width 0.5s;"></div>
                    </div>
                </div>
            `;
            
            try {
                // Build transformation parameters based on selected options
                const toolType = document.querySelector('input[name="tool-type"]:checked').value;
                const transformations = [];
                
                // Get the original public ID from the uploaded image
                const publicId = uploadedImageInfo.public_id;
                const format = uploadedImageInfo.format;
                
                // Add size transformation based on selected sizing method
                const sizeType = document.getElementById('output-size-type').value;
                let width, height;
                
                if (sizeType === 'custom') {
                    // Use custom width and height from sliders
                    width = document.getElementById('width-control').value;
                    height = document.getElementById('height-control').value;
                } 
                else if (sizeType === 'preset') {
                    // Use preset dimensions from dropdown
                    const outputSize = document.getElementById('output-size').value;
                    if (outputSize) {
                        [width, height] = outputSize.split('x');
                    }
                } else {
                    // Original size
                    width = uploadedImageInfo.width;
                    height = uploadedImageInfo.height;
                }
                
                // Add transformations based on tool type
                if (toolType === 'resize') {
                    const resizeMode = document.getElementById('resize-mode').value;
                    switch(resizeMode) {
                        case 'scale':
                            transformations.push(`c_scale,w_${width},h_${height}`);
                            break;
                        case 'fit':
                            transformations.push(`c_fit,w_${width},h_${height}`);
                            break;
                        case 'fill':
                            transformations.push(`c_fill,w_${width},h_${height},g_auto`);
                            break;
                        case 'pad':
                            transformations.push(`c_pad,w_${width},h_${height}`);
                            break;
                        case 'limit':
                            transformations.push(`c_limit,w_${width},h_${height}`);
                            break;
                        default:
                            transformations.push(`c_scale,w_${width},h_${height}`);
                    }
                } 
                else if (toolType === 'crop') {
                    const cropMode = document.getElementById('crop-mode').value;
                    const gravity = document.getElementById('gravity').value;
                    
                    switch(cropMode) {
                        case 'fill':
                            transformations.push(`c_fill,w_${width},h_${height},g_${gravity}`);
                            break;
                        case 'lfill':
                            transformations.push(`c_lfill,w_${width},h_${height},g_${gravity}`);
                            break;
                        case 'fill_pad':
                            transformations.push(`c_fill_pad,w_${width},h_${height},g_${gravity}`);
                            break;
                        case 'crop':
                            transformations.push(`c_crop,w_${width},h_${height},g_${gravity}`);
                            break;
                        case 'thumb':
                            transformations.push(`c_thumb,w_${width},h_${height},g_${gravity}`);
                            break;
                        default:
                            // For custom crop, we would use the crop coordinates, but this is simplified for now
                            transformations.push(`c_crop,w_${width},h_${height},g_${gravity}`);
                    }
                } 
                else if (toolType === 'background') {
                    // NOTE: Background removal is a premium Cloudinary feature that may require credits
                    transformations.push(`e_background_removal`);
                    
                    // Only add size transformation if explicitly requested
                    if (sizeType !== 'original') {
                        transformations.push(`c_scale,w_${width},h_${height}`);
                    }
                    
                    // Background replacement if needed
                    const backgroundReplacement = document.getElementById('background-replacement').value;
                    if (backgroundReplacement === 'color') {
                        const bgColor = document.getElementById('bg-color').value.substring(1); // Remove # from color
                        transformations.push(`b_${bgColor}`);
                    } 
                    else if (backgroundReplacement === 'gradient') {
                        const gradientStart = document.getElementById('gradient-start').value.substring(1);
                        const gradientEnd = document.getElementById('gradient-end').value.substring(1);
                        transformations.push(`b_gradient:${gradientStart}:${gradientEnd}`);
                    }
                }
                
                // Add format and quality settings
                const outputFormat = document.getElementById('output-format').value;
                if (outputFormat && outputFormat !== 'auto') {
                    transformations.push(`f_${outputFormat}`);
                } else {
                    transformations.push('f_auto');
                }
                
                const optimizeQuality = document.getElementById('optimize-quality').checked;
                if (optimizeQuality) {
                    transformations.push('q_auto');
                }
                
                // Update progress bar
                const progressBar = processedImageDisplay.querySelector('.progress');
                progressBar.style.width = '60%';
                
                // Create the transformation URL
                let transformationString = transformations.join('/');
                if (!transformationString) transformationString = 'c_scale,w_800';
                
                // Final transformation URL using Cloudinary's format
                transformedImageUrl = `https://res.cloudinary.com/dwa9nkpyq/image/upload/${transformationString}/${publicId}.${format}`;
                console.log("Generated transformation URL:", transformedImageUrl);
                
                // Update progress bar
                progressBar.style.width = '80%';
                
                // Display the transformed image
                processedImageDisplay.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <img 
                            id="processed-image"
                            src="${transformedImageUrl}" 
                            style="max-width: 100%; max-height: 350px; object-fit: contain; opacity: 0; transition: opacity 0.5s;" 
                            alt="Processed Image"
                            onload="this.style.opacity = '1';"
                            onerror="handleImageError('${toolType}', '${publicId}', '${format}')"
                        />
                        <div id="utility-error" style="display: none; color: #ff5555; text-align: center; margin-top: 20px;">
                            <p>Error loading the processed image.</p>
                            <p id="error-message"></p>
                            <button id="simple-transform-btn" style="padding: 8px 12px; background: #7b2cbf; border: none; color: white; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Try Simple Transformation
                            </button>
                        </div>
                        <p style="color: #4CAF50; margin-top: 15px; text-align: center;">‚ú® Processing complete!</p>
                    </div>
                `;
                
                // Also update the tool-specific display if it exists (for background removal)
                if (toolType === 'background') {
                    const bgRemovedDisplay = document.getElementById('bg-removed-display');
                    if (bgRemovedDisplay) {
                        bgRemovedDisplay.innerHTML = `
                            <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <img 
                                    src="${transformedImageUrl}" 
                                    style="max-width: 100%; max-height: 350px; object-fit: contain; opacity: 0; transition: opacity 0.5s;" 
                                    alt="Background Removed"
                                    onload="this.style.opacity = '1';"
                                    onerror="document.getElementById('bg-error').style.display = 'block'; this.style.display = 'none';"
                                />
                                <div id="bg-error" style="display: none; color: #ff5555; text-align: center; margin-top: 20px;">
                                    <p>Background removal failed. This feature may require a premium Cloudinary account.</p>
                                    <button onclick="trySimpleTransformation('${publicId}', '${format}')" style="padding: 8px 12px; background: #7b2cbf; border: none; color: white; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                        Try Alternative Effect
                                    </button>
                                </div>
                                <p style="color: #4CAF50; margin-top: 15px; text-align: center;">‚úÖ Background removal processing...</p>
                            </div>
                        `;
                    }
                }
                
                // Enable download button
                downloadButton.disabled = false;
                
                // Add simple transform button event listener after displaying results
                const simpleTransformBtn = document.getElementById('simple-transform-btn');
                if (simpleTransformBtn) {
                    simpleTransformBtn.addEventListener('click', () => {
                        trySimpleTransformation(publicId, format);
                    });
                }
                
            } catch (error) {
                console.error("Processing error:", error);
                processedImageDisplay.innerHTML = `
                    <div class="placeholder">
                        <p style="color: #ff5555;">Error processing image</p>
                        <p>${error.message || "Unknown error"}</p>
                    </div>
                `;
            } finally {
                // Restore button state
                applyButton.disabled = false;
                applyButton.textContent = "üîÑ Process Image";
            }
        });
        
        // Download button - opens the image in a new tab
        downloadButton.addEventListener('click', () => {
            if (transformedImageUrl) {
                window.open(transformedImageUrl, '_blank');
            }
        });
        
        // Reset button
        resetButton.addEventListener('click', () => {
            // Reset to upload state
            uploadArea.style.display = 'block';
            resultContainer.style.display = 'none';
            
            // Reset Cloudinary data
            uploadedImageInfo = null;
            transformedImageUrl = '';
            
            // Reset sliders
            sliders.forEach(slider => {
                slider.value = slider.defaultValue;
                const valueDisplay = slider.previousElementSibling.querySelector('span');
                if (valueDisplay) valueDisplay.textContent = slider.defaultValue;
            });
            
            // Reset checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = checkbox.defaultChecked;
            });
            
            // Reset dropdowns
            document.querySelectorAll('select').forEach(select => {
                select.value = select.options[0].value;
            });
            
            // Reset to resize tool type
            document.querySelector('input[name="tool-type"][value="resize"]').checked = true;
            
            // Trigger the change event to update UI
            const event = new Event('change');
            document.querySelector('input[name="tool-type"][value="resize"]').dispatchEvent(event);
            
            // Reset background displays
            const bgOriginalDisplay = document.getElementById('bg-original-display');
            const bgRemovedDisplay = document.getElementById('bg-removed-display');
            if (bgOriginalDisplay) bgOriginalDisplay.innerHTML = '';
            if (bgRemovedDisplay) bgRemovedDisplay.innerHTML = '';
            
            // Reset crop image
            const cropImage = document.getElementById('crop-image');
            if (cropImage) cropImage.src = '';
        });
        
        // Helper function to show error messages
        function showError(message) {
            // Display the error in the UI
            const errorToast = document.createElement('div');
            errorToast.className = 'error-toast';
            errorToast.innerHTML = `<p>${message}</p>`;
            errorToast.style.position = 'fixed';
            errorToast.style.bottom = '20px';
            errorToast.style.left = '50%';
            errorToast.style.transform = 'translateX(-50%)';
            errorToast.style.backgroundColor = 'rgba(255, 50, 50, 0.9)';
            errorToast.style.color = 'white';
            errorToast.style.padding = '10px 20px';
            errorToast.style.borderRadius = '5px';
            errorToast.style.zIndex = '1000';
            
            document.body.appendChild(errorToast);
            
            // Remove after 5 seconds
            setTimeout(() => {
                errorToast.style.opacity = '0';
                errorToast.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(errorToast);
                }, 500);
            }, 5000);
        }

        // Initialize stars
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            
            // Update aspect ratio when image is uploaded
            const originalInterval = setInterval(() => {
                if (uploadedImageInfo) {
                    updateAspectRatioFromImage();
                    clearInterval(originalInterval);
                }
            }, 500);
        });

        // Add global error handler for image loading
        function handleImageError(toolType, publicId, format) {
            // Show the error container
            const errorContainer = document.getElementById('utility-error');
            const errorMessage = document.getElementById('error-message');
            const processedImage = document.getElementById('processed-image');
            
            if (errorContainer) {
                errorContainer.style.display = 'block';
            }
            
            if (processedImage) {
                processedImage.style.display = 'none';
            }
            
            // Set specific error message based on tool type
            if (toolType === 'background') {
                if (errorMessage) {
                    errorMessage.textContent = 'Background removal failed. This feature may require a premium Cloudinary account.';
                }
                
                // Automatically try an alternative effect for background removal
                tryAlternativeEffect(publicId, format);
            } else {
                if (errorMessage) {
                    errorMessage.textContent = 'Error processing the image with the selected settings.';
                }
            }
        }
        
        // Function to try an alternative effect when background removal fails
        function tryAlternativeEffect(publicId, format) {
            // Create a cartoonify effect as an alternative to background removal
            const alternativeUrl = `https://res.cloudinary.com/dwa9nkpyq/image/upload/e_cartoonify/c_scale,w_800/${publicId}.${format}`;
            transformedImageUrl = alternativeUrl;
            
            // Update the display
            processedImageDisplay.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <img 
                        src="${alternativeUrl}" 
                        style="max-width: 100%; max-height: 350px; object-fit: contain;" 
                        alt="Alternative Effect"
                    />
                    <p style="color: #FFD700; margin-top: 15px; text-align: center;">‚ö†Ô∏è Background removal unavailable. Using cartoonify effect instead.</p>
                </div>
            `;
            
            // Also update the bg-removed-display if it exists
            const bgRemovedDisplay = document.getElementById('bg-removed-display');
            if (bgRemovedDisplay) {
                bgRemovedDisplay.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <img 
                            src="${alternativeUrl}" 
                            style="max-width: 100%; max-height: 350px; object-fit: contain;" 
                            alt="Alternative Effect"
                        />
                        <p style="color: #FFD700; margin-top: 15px; text-align: center;">‚ö†Ô∏è Using cartoonify effect instead</p>
                    </div>
                `;
            }
            
            // Enable download button
            downloadButton.disabled = false;
        }
        
        // Function to try simple transformation instead
        function trySimpleTransformation(publicId, format) {
            const simpleUrl = `https://res.cloudinary.com/dwa9nkpyq/image/upload/c_scale,w_800/${publicId}.${format}`;
            transformedImageUrl = simpleUrl;
            
            processedImageDisplay.innerHTML = `
                <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <img 
                        src="${simpleUrl}" 
                        style="max-width: 100%; max-height: 350px; object-fit: contain;" 
                        alt="Processed Image (Simple)"
                    />
                    <p style="color: #FFD700; margin-top: 15px; text-align: center;">‚ö†Ô∏è Using simplified transformation</p>
                </div>
            `;
            
            // Enable download button
            downloadButton.disabled = false;
        }
    </script>
</body>
</html> 