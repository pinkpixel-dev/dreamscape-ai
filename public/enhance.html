<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✨ Dreamscape AI - Image Enhancer & Resizer</title>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Quicksand:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="css/enhance.css">
    <link rel="stylesheet" href="css/cloudinary.css">
    <link rel="icon" type="image/png" href="../favicon.png">
    <!-- Add Cloudinary SDK with onload handler -->
    <script>
        function onCloudinaryLoaded() {
            console.log('Cloudinary script loaded successfully');
            // Dispatch a custom event that our code can listen for
            window.dispatchEvent(new Event('cloudinaryLoaded'));
        }
    </script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript" onload="onCloudinaryLoaded()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/url-polyfill/1.1.12/url-polyfill.min.js"></script>

    <!-- Initialize Cloudinary widget -->
    <script>
        // Initialize widget when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking for Cloudinary...');
            initCloudinaryWidget();
        });

        // Also initialize when Cloudinary is loaded
        window.addEventListener('cloudinaryLoaded', function() {
            console.log('Cloudinary loaded event received');
            initCloudinaryWidget();
        });

        // Global widget variable
        let uploadWidget = null;

        // Function to show error messages
        function showErrorMessage(message) {
            // Create error message element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.left = '50%';
            errorDiv.style.transform = 'translateX(-50%)';
            errorDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            errorDiv.style.color = '#ff5555';
            errorDiv.style.padding = '15px 20px';
            errorDiv.style.borderRadius = '8px';
            errorDiv.style.boxShadow = '0 0 15px rgba(0, 0, 0, 0.5)';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.maxWidth = '80%';
            errorDiv.style.textAlign = 'center';

            errorDiv.innerHTML = `
                <div style="margin-bottom:8px;font-weight:bold;">⚠️ Error</div>
                <div>${message}</div>
                <div style="margin-top:10px;font-size:12px;opacity:0.7">Tap to dismiss</div>
            `;

            // Add click listener to dismiss
            errorDiv.addEventListener('click', () => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            });

            // Auto dismiss after 8 seconds
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 8000);
        }

        // Widget initialization function
        function initCloudinaryWidget() {
            if (typeof cloudinary !== 'undefined' && !uploadWidget) {
                console.log('Initializing Cloudinary widget...');

                // Function to generate signature via our server endpoint
                const generateSignature = function(callback, paramsToSign) {
                    fetch('/cloudinary-signature', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ params_to_sign: paramsToSign })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.signature) {
                            callback(data.signature);
                        } else {
                            console.error('Signature generation failed:', data.error);
                            showErrorMessage('Failed to generate upload signature');
                        }
                    })
                    .catch(error => {
                        console.error('Error calling signature endpoint:', error);
                        showErrorMessage('Failed to generate upload signature');
                    });
                };

                // Create the widget with minimal configuration
                uploadWidget = cloudinary.createUploadWidget({
                    cloudName: 'dwa9nkpyq',
                    apiKey: '887549877845179',
                    uploadSignature: generateSignature,
                    sources: ['local', 'url', 'camera'],
                    multiple: false,
                    maxFiles: 1,
                    cropping: false,
                    showAdvancedOptions: false,
                    showUploadMoreButton: false,
                    singleUploadAutoClose: true,
                    styles: {
                        palette: {
                            window: "#000000",
                            sourceBg: "#000000",
                            windowBorder: "#8E9FBF",
                            tabIcon: "#FFFFFF",
                            inactiveTabIcon: "#8E9FBF",
                            menuIcons: "#2AD9FF",
                            link: "#08C0FF",
                            action: "#336BFF",
                            inProgress: "#00BFFF",
                            complete: "#33ff00",
                            error: "#EA2727",
                            textDark: "#000000",
                            textLight: "#FFFFFF"
                        }
                    }
                }, (error, result) => {
                    if (error) {
                        console.error('Cloudinary widget error:', error);
                        // Display error message to user
                        showErrorMessage('Upload error: ' + (error.message || 'Failed to upload image'));
                        return;
                    }

                    // Handle different widget events
                    if (!result) return;

                    console.log('Widget event:', result.event);

                    // Handle upload error event
                    if (result.event === "upload-error") {
                        console.error('Upload error:', result.error);
                        showErrorMessage('Upload error: ' + (result.error?.message || 'Failed to upload image'));
                        return;
                    }

                    // Handle successful upload
                    if (result.event === "success") {
                        console.log('Upload successful:', result.info);

                        // Display the uploaded image
                        const uploadArea = document.getElementById('upload-area');
                        const resultContainer = document.getElementById('result-container');

                        if (uploadArea && resultContainer) {
                            // Hide upload area
                            uploadArea.style.display = 'none';

                            // Show result container
                            resultContainer.style.display = 'block';

                            // Set original image
                            const originalImageDisplay = document.getElementById('original-image-display');
                            if (originalImageDisplay) {
                                originalImageDisplay.innerHTML = '';
                                const img = document.createElement('img');
                                img.src = result.info.secure_url;
                                img.alt = 'Original Image';
                                img.className = 'preview-img';

                                // Add onload event to dispatch imageLoaded event with dimensions
                                img.onload = function() {
                                    // Dispatch custom event with image dimensions
                                    const imageLoadedEvent = new CustomEvent('imageLoaded', {
                                        detail: {
                                            width: this.naturalWidth,
                                            height: this.naturalHeight
                                        }
                                    });
                                    document.dispatchEvent(imageLoadedEvent);

                                    // Update aspect ratio for resize controls
                                    const widthSlider = document.getElementById('resize-width');
                                    const heightSlider = document.getElementById('resize-height');
                                    if (widthSlider && heightSlider) {
                                        widthSlider.value = this.naturalWidth > 2000 ? 2000 : this.naturalWidth;
                                        heightSlider.value = this.naturalHeight > 2000 ? 2000 : this.naturalHeight;

                                        // Update displayed values
                                        const widthLabel = widthSlider.previousElementSibling;
                                        const heightLabel = heightSlider.previousElementSibling;
                                        if (widthLabel && widthLabel.tagName === 'LABEL') {
                                            const valueSpan = widthLabel.querySelector('span');
                                            if (valueSpan) {
                                                valueSpan.textContent = widthSlider.value;
                                            }
                                        }
                                        if (heightLabel && heightLabel.tagName === 'LABEL') {
                                            const valueSpan = heightLabel.querySelector('span');
                                            if (valueSpan) {
                                                valueSpan.textContent = heightSlider.value;
                                            }
                                        }
                                    }
                                };

                                originalImageDisplay.appendChild(img);
                            }

                            // Enable enhance button
                            const enhanceButton = document.getElementById('enhance-button');
                            if (enhanceButton) {
                                enhanceButton.disabled = false;
                            }
                        }
                    }
                });

                console.log('Widget created successfully');

                // Set up click handler for upload area
                const uploadArea = document.getElementById('upload-area');
                if (uploadArea) {
                    uploadArea.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('Upload area clicked, opening widget...');
                        if (uploadWidget) {
                            uploadWidget.open();
                        } else {
                            console.error('Widget not initialized yet');
                        }
                    });
                }
            } else {
                console.log('Cloudinary not available yet or widget already initialized');
            }
        }
    </script>
</head>
<body>
    <div class="stars"></div>
    <div class="twinkling"></div>
    <div class="moon-container">
        <img class="moon-img" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/moon2.png" alt="moon" style="filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.9));">
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../favicon.png" alt="Dreamscape AI" class="sidebar-logo">
                <span>Creative Studio✨</span>
            </div>

            <div class="sidebar-section">
                <p class="section-title">📋 Navigation</p>
                <a href="../index.html" class="nav-link">🏠 Home</a>
                <a href="generate.html" class="nav-link">🌌 Generate Images</a>
                <a href="enhance.html" class="nav-link active">✨ Enhance & Resize</a>
                <a href="artistic.html" class="nav-link">🎨 Artistic Effects</a>
                <a href="chat.html" class="nav-link">💬 Text Chat</a>
                <a href="voice.html" class="nav-link">🎤 Voice Assistant</a>
            </div>

            <div class="sidebar-section">
                <p class="section-title">✨ Enhancement Type</p>
                <div class="control-group">
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="enhancement-type" value="basic" checked>
                            🔧 Basic Adjustments
                        </label>
                        <label>
                            <input type="radio" name="enhancement-type" value="auto">
                            🪄 Auto-Enhance
                        </label>
                        <label>
                            <input type="radio" name="enhancement-type" value="advanced">
                            💎 Advanced Quality
                        </label>
                        <label>
                            <input type="radio" name="enhancement-type" value="resize">
                            📏 Resize Image
                        </label>
                    </div>
              </div>
            </div>

            <div class="sidebar-section" id="basic-controls">
                <p class="section-title">🖌️ Basic Adjustments</p>
                <div class="control-group slider-control">
                    <label for="saturation-control">Saturation <span>0</span></label>
                    <input type="range" id="saturation-control" min="-100" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="contrast-control">Contrast <span>0</span></label>
                    <input type="range" id="contrast-control" min="-100" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="brightness-control">Brightness <span>0</span></label>
                    <input type="range" id="brightness-control" min="-100" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="sharpness-control">Sharpness <span>0</span></label>
                    <input type="range" id="sharpness-control" min="0" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="vibrance-control">Vibrance <span>0</span></label>
                    <input type="range" id="vibrance-control" min="0" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="gamma-control">Gamma <span>0</span></label>
                    <input type="range" id="gamma-control" min="-50" max="50" value="0">
              </div>
            </div>

            <div class="sidebar-section" id="auto-controls" style="display: none;">
                <p class="section-title">🪄 Auto Enhancement</p>
                <div class="control-group">
                    <label for="auto-color">
                        <input type="checkbox" id="auto-color" checked>
                        🌈 Auto Color
                    </label>
                </div>
                <div class="control-group">
                    <label for="auto-contrast">
                        <input type="checkbox" id="auto-contrast" checked>
                        🌓 Auto Contrast
                    </label>
                </div>
                <div class="control-group">
                    <label for="auto-brightness">
                        <input type="checkbox" id="auto-brightness" checked>
                        ☀️ Auto Brightness
                    </label>
                </div>
                <div class="control-group">
                    <label for="auto-sharpen">
                        <input type="checkbox" id="auto-sharpen" checked>
                        🔍 Auto Sharpen
                    </label>
              </div>
            </div>

            <div class="sidebar-section" id="advanced-controls" style="display: none;">
                <p class="section-title">💎 Advanced Quality</p>
                <div class="control-group">
                    <label for="improve">
                        <input type="checkbox" id="improve" checked>
                        ✨ Improve (General quality boost)
                    </label>
                </div>
                <div class="control-group">
                    <label for="enhance">
                        <input type="checkbox" id="enhance" checked>
                        💫 Enhance (Colors & contrast)
                    </label>
              </div>
                <div class="control-group">
                    <label for="quality-auto">
                        <input type="checkbox" id="quality-auto" checked>
                        ⚙️ Auto Quality Optimization
                    </label>
            </div>
                <div class="control-group">
                    <label for="format-auto">
                        <input type="checkbox" id="format-auto" checked>
                        📦 Auto Format Selection
                    </label>
          </div>
                <div class="control-group slider-control">
                    <label for="unsharp-mask">Unsharp Mask <span>0</span></label>
                    <input type="range" id="unsharp-mask" min="0" max="100" value="0">
        </div>
            </div>

            <!-- Add new resize controls section -->
            <div class="sidebar-section" id="resize-controls" style="display: none;">
                <p class="section-title">📏 Resize Settings</p>
                <div class="control-group">
                    <label for="resize-mode">Resize Mode</label>
                    <select id="resize-mode">
                        <option value="scale">Scale (Change dimensions)</option>
                        <option value="fit">Fit (Preserve aspect ratio)</option>
                        <option value="fill">Fill (Cover area, may crop)</option>
                        <option value="pad">Pad (Add padding if needed)</option>
                        <option value="limit">Limit (Down-scale only)</option>
                    </select>
                </div>
                <div class="control-group slider-control">
                    <label for="resize-width">Width <span>800</span>px</label>
                    <input type="range" id="resize-width" min="100" max="2000" value="800">
                </div>
                <div class="control-group slider-control">
                    <label for="resize-height">Height <span>600</span>px</label>
                    <input type="range" id="resize-height" min="100" max="2000" value="600">
                </div>
                <div class="control-group">
                    <label for="resize-maintain-aspect">
                        <input type="checkbox" id="resize-maintain-aspect" checked>
                        🔒 Maintain Aspect Ratio
                    </label>
                </div>
            </div>

            <div class="sidebar-section" id="download-options">
                <p class="section-title">💾 Download Options</p>
                <div class="control-group">
                    <label for="download-format">Image Format</label>
                    <select id="download-format">
                        <option value="jpg">JPEG (jpg)</option>
                        <option value="png">PNG (png)</option>
                        <option value="webp">WebP (webp)</option>
                        <option value="auto">Auto (Best format)</option>
                    </select>
                </div>
                <div class="control-group slider-control">
                    <label for="download-quality">Quality <span>90</span>%</label>
                    <input type="range" id="download-quality" min="10" max="100" value="90">
                </div>
            </div>

            <div class="sidebar-section">
                <p class="section-title">ℹ️ About</p>
                <div class="control-group enhance-description">
                    <p>Enhance your images by choosing from basic adjustments, auto-enhance or advanced quality settings.</p>
                    <p>Your images are processed securely and are not stored on our servers.</p>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="title-container">
                <div class="title-wrapper">
                    <h1>Image Enhancer & Resizer ✨</h1>
                </div>
                <p class="subtitle-text">Transform and resize your images with powerful tools</p>
            </div>

            <div class="content-area">
                <div class="upload-area" id="upload-area">
                    <div id="upload-content">
                        <div class="upload-icon">📁</div>
                        <h3>Upload Image</h3>
                        <p>Click to browse or drag & drop</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>
                </div>

                <div class="result-container" id="result-container" style="display: none;">
                    <div class="image-comparison">
                        <div class="original-image">
                            <h3>Original Image</h3>
                            <div class="image-holder" id="original-image-display"></div>
                        </div>
                        <div class="enhanced-image">
                            <h3>Enhanced Image</h3>
                            <div class="image-holder" id="enhanced-image-display"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="enhance-button" class="action-button">✨ Apply Enhancements</button>
                        <button id="download-button" class="action-button" disabled>💾 Download Result</button>
                        <button id="reset-button" class="action-button">🔄 Reset</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="js/cloudinary-api.js"></script>
    <script src="../styles.js"></script>
    <script src="../script.js"></script>

    <script>
        // Handle button functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Get button elements
            const enhanceButton = document.getElementById('enhance-button');
            const downloadButton = document.getElementById('download-button');
            const resetButton = document.getElementById('reset-button');

            // Variables to store image data
            let originalImageUrl = null;
            let enhancedImageUrl = null;

            // Handle enhance button click
            if (enhanceButton) {
                enhanceButton.addEventListener('click', function() {
                    // Get the original image element
                    const originalImageDisplay = document.getElementById('original-image-display');
                    const enhancedImageDisplay = document.getElementById('enhanced-image-display');

                    if (originalImageDisplay && originalImageDisplay.querySelector('img')) {
                        // Show loading state
                        enhanceButton.disabled = true;
                        enhanceButton.textContent = '⏳ Processing...';

                        // Get the original image URL
                        originalImageUrl = originalImageDisplay.querySelector('img').src;

                        // Get enhancement settings
                        const enhancementType = document.querySelector('input[name="enhancement-type"]:checked').value;

                        // Create a new enhanced image with Cloudinary transformations
                        let transformations = '';

                        if (enhancementType === 'basic') {
                            // Get basic adjustment values
                            const saturation = document.getElementById('saturation-control').value;
                            const contrast = document.getElementById('contrast-control').value;
                            const brightness = document.getElementById('brightness-control').value;
                            const sharpness = document.getElementById('sharpness-control').value;

                            // Build transformation string
                            if (saturation !== '0') transformations += 'e_saturation:' + saturation + '/';
                            if (contrast !== '0') transformations += 'e_contrast:' + contrast + '/';
                            if (brightness !== '0') transformations += 'e_brightness:' + brightness + '/';
                            if (sharpness !== '0') transformations += 'e_sharpen:' + sharpness + '/';
                        } else if (enhancementType === 'auto') {
                            // Auto enhancements
                            if (document.getElementById('auto-color').checked) transformations += 'e_auto_color/';
                            if (document.getElementById('auto-contrast').checked) transformations += 'e_auto_contrast/';
                            if (document.getElementById('auto-brightness').checked) transformations += 'e_auto_brightness/';
                            if (document.getElementById('auto-sharpen').checked) transformations += 'e_improve/';
                        } else if (enhancementType === 'advanced') {
                            // Advanced quality settings
                            if (document.getElementById('improve').checked) transformations += 'e_improve/';
                            if (document.getElementById('enhance').checked) transformations += 'e_enhance/';
                            if (document.getElementById('quality-auto').checked) transformations += 'q_auto/';
                            if (document.getElementById('format-auto').checked) transformations += 'f_auto/';

                            const unsharpMask = document.getElementById('unsharp-mask').value;
                            if (unsharpMask !== '0') transformations += 'e_unsharp_mask:' + unsharpMask + '/';
                        } else if (enhancementType === 'resize') {
                            // Resize settings
                            const resizeMode = document.getElementById('resize-mode').value;
                            const width = document.getElementById('resize-width').value;
                            const height = document.getElementById('resize-height').value;

                            // Use the correct Cloudinary transformation format
                            // c_fill, c_fit, c_limit, c_pad, c_scale are the valid crop modes
                            const cropMode = resizeMode === 'scale' ? 'c_scale' :
                                            resizeMode === 'fit' ? 'c_fit' :
                                            resizeMode === 'fill' ? 'c_fill' :
                                            resizeMode === 'pad' ? 'c_pad' :
                                            resizeMode === 'limit' ? 'c_limit' : 'c_scale';

                            // Ensure width and height are valid numbers
                            const validWidth = parseInt(width, 10) || 800;
                            const validHeight = parseInt(height, 10) || 600;

                            // Format the transformation string correctly
                            transformations += cropMode + ',w_' + validWidth + ',h_' + validHeight + '/';
                        }

                        // Apply transformations to the Cloudinary URL
                        // Extract the Cloudinary URL parts
                        const urlParts = originalImageUrl.split('/upload/');
                        if (urlParts.length === 2) {
                            enhancedImageUrl = urlParts[0] + '/upload/' + transformations + urlParts[1];

                            // Debug log the transformation URL
                            console.log('Applying transformation:', transformations);
                            console.log('Enhanced image URL:', enhancedImageUrl);

                            // Create and display the enhanced image
                            const enhancedImg = document.createElement('img');
                            enhancedImg.alt = 'Enhanced Image';
                            enhancedImg.className = 'preview-img';

                            // Add error handling
                            enhancedImg.onerror = function() {
                                console.error('Failed to load enhanced image:', enhancedImageUrl);
                                showErrorMessage('Failed to apply transformation. Please try different settings.');

                                // Reset enhance button
                                enhanceButton.textContent = '✨ Apply Enhancements';
                                enhanceButton.disabled = false;

                                // Remove the broken image
                                if (this.parentNode) {
                                    this.parentNode.removeChild(this);
                                }
                            };

                            // Set source after adding error handler
                            enhancedImg.src = enhancedImageUrl;

                            // Clear previous content and add the new image
                            enhancedImageDisplay.innerHTML = '';
                            enhancedImageDisplay.appendChild(enhancedImg);

                            // Add load event handler
                            enhancedImg.onload = function() {
                                // Enable download button
                                downloadButton.disabled = false;

                                // Reset enhance button
                                enhanceButton.textContent = '✨ Apply Enhancements';
                                enhanceButton.disabled = false;
                            };
                        } else {
                            // Handle non-Cloudinary images
                            showErrorMessage('Cannot enhance this image. Please upload an image through the Cloudinary widget.');
                            enhanceButton.textContent = '✨ Apply Enhancements';
                            enhanceButton.disabled = false;
                        }
                    }
                });
            }

            // Handle download button click
            if (downloadButton) {
                downloadButton.addEventListener('click', function() {
                    if (enhancedImageUrl) {
                        // Show loading state
                        downloadButton.disabled = true;
                        downloadButton.textContent = '⏳ Downloading...';

                        // Get selected format and quality
                        const format = document.getElementById('download-format').value;
                        const quality = document.getElementById('download-quality').value;

                        // Create a modified URL with format and quality parameters
                        let downloadUrl = enhancedImageUrl;

                        try {
                            // Parse the Cloudinary URL
                            const urlParts = enhancedImageUrl.split('/upload/');

                            if (urlParts.length === 2) {
                                // Prepare format transformation
                                let formatTransformation = '';

                                if (format === 'auto') {
                                    formatTransformation = 'f_auto';
                                } else {
                                    formatTransformation = 'f_' + format;
                                }

                                // Add quality parameter
                                formatTransformation += ',q_' + quality;

                                // Simpler approach: just add our format transformation to existing ones
                                // This avoids complex parsing that might break
                                downloadUrl = urlParts[0] + '/upload/' + formatTransformation + '/' + urlParts[1];

                                console.log('Download URL:', downloadUrl);
                            }

                            // Set filename with correct extension
                            let filename = 'enhanced-image';
                            if (format !== 'auto') {
                                filename += '.' + format;
                            } else {
                                filename += '.jpg'; // Default extension for auto format
                            }

                            // Method 1: Direct download with a tag
                            const downloadLink = document.createElement('a');

                            // Create an image element to preload the image
                            const img = new Image();
                            img.crossOrigin = 'Anonymous'; // Enable CORS

                            img.onload = function() {
                                // Create a canvas to draw the image
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;

                                // Draw the image on the canvas
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);

                                // Convert canvas to blob
                                canvas.toBlob(function(blob) {
                                    // Create download link
                                    const url = URL.createObjectURL(blob);
                                    downloadLink.href = url;
                                    downloadLink.download = filename;

                                    // Trigger download
                                    document.body.appendChild(downloadLink);
                                    downloadLink.click();

                                    // Clean up
                                    setTimeout(function() {
                                        document.body.removeChild(downloadLink);
                                        URL.revokeObjectURL(url);

                                        // Reset button state
                                        downloadButton.disabled = false;
                                        downloadButton.textContent = '💾 Download Result';
                                    }, 100);
                                }, format === 'jpg' ? 'image/jpeg' : format === 'png' ? 'image/png' : format === 'webp' ? 'image/webp' : 'image/jpeg', quality / 100);
                            };

                            img.onerror = function() {
                                console.error('Failed to load image for download');
                                showErrorMessage('Failed to download image. Please try again.');

                                // Reset button state
                                downloadButton.disabled = false;
                                downloadButton.textContent = '💾 Download Result';

                                // Fallback to direct URL
                                window.open(downloadUrl, '_blank');
                            };

                            // Start loading the image
                            img.src = downloadUrl;
                        } catch (error) {
                            console.error('Error preparing download:', error);
                            showErrorMessage('Failed to prepare download. Please try again.');

                            // Reset button state
                            downloadButton.disabled = false;
                            downloadButton.textContent = '💾 Download Result';

                            // Fallback to opening in new tab
                            window.open(enhancedImageUrl, '_blank');
                        }
                    }
                });
            }

            // Handle reset button click
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    // Hide result container
                    const resultContainer = document.getElementById('result-container');
                    if (resultContainer) {
                        resultContainer.style.display = 'none';
                    }

                    // Show upload area
                    const uploadArea = document.getElementById('upload-area');
                    if (uploadArea) {
                        uploadArea.style.display = 'block';
                    }

                    // Clear image displays
                    const originalImageDisplay = document.getElementById('original-image-display');
                    const enhancedImageDisplay = document.getElementById('enhanced-image-display');

                    if (originalImageDisplay) originalImageDisplay.innerHTML = '';
                    if (enhancedImageDisplay) enhancedImageDisplay.innerHTML = '';

                    // Reset variables
                    originalImageUrl = null;
                    enhancedImageUrl = null;

                    // Reset buttons
                    if (enhanceButton) enhanceButton.disabled = true;
                    if (downloadButton) downloadButton.disabled = true;
                });
            }
        });

        // Initialize slider value updates
        document.addEventListener('DOMContentLoaded', function() {
            // Get all slider controls
            const sliders = document.querySelectorAll('input[type="range"]');

            // Add input event listeners to update the displayed values
            sliders.forEach(slider => {
                const label = slider.previousElementSibling;
                if (label && label.tagName === 'LABEL') {
                    const valueSpan = label.querySelector('span');
                    if (valueSpan) {
                        // Update initial value
                        valueSpan.textContent = slider.value;

                        // Add event listener for changes
                        slider.addEventListener('input', function() {
                            valueSpan.textContent = this.value;
                        });
                    }
                }
            });

            // Handle enhancement type radio buttons
            const enhancementTypeRadios = document.querySelectorAll('input[name="enhancement-type"]');
            const basicControls = document.getElementById('basic-controls');
            const autoControls = document.getElementById('auto-controls');
            const advancedControls = document.getElementById('advanced-controls');
            const resizeControls = document.getElementById('resize-controls');

            if (enhancementTypeRadios && basicControls && autoControls && advancedControls && resizeControls) {
                enhancementTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        // Hide all controls
                        basicControls.style.display = 'none';
                        autoControls.style.display = 'none';
                        advancedControls.style.display = 'none';
                        resizeControls.style.display = 'none';

                        // Show selected controls
                        if (this.value === 'basic') {
                            basicControls.style.display = 'block';
                        } else if (this.value === 'auto') {
                            autoControls.style.display = 'block';
                        } else if (this.value === 'advanced') {
                            advancedControls.style.display = 'block';
                        } else if (this.value === 'resize') {
                            resizeControls.style.display = 'block';
                        }
                    });
                });
            }

            // Handle maintain aspect ratio checkbox for resize
            const maintainAspectCheckbox = document.getElementById('resize-maintain-aspect');
            const widthSlider = document.getElementById('resize-width');
            const heightSlider = document.getElementById('resize-height');

            if (maintainAspectCheckbox && widthSlider && heightSlider) {
                // Store original aspect ratio
                let aspectRatio = widthSlider.value / heightSlider.value;

                // Update aspect ratio when image is loaded
                document.addEventListener('imageLoaded', function(e) {
                    if (e.detail && e.detail.width && e.detail.height) {
                        aspectRatio = e.detail.width / e.detail.height;
                    }
                });

                // Handle width changes
                widthSlider.addEventListener('input', function() {
                    if (maintainAspectCheckbox.checked) {
                        // Calculate new height based on aspect ratio
                        const newHeight = Math.round(this.value / aspectRatio);
                        // Update height slider
                        heightSlider.value = newHeight;
                        // Update displayed value
                        const heightLabel = heightSlider.previousElementSibling;
                        if (heightLabel && heightLabel.tagName === 'LABEL') {
                            const valueSpan = heightLabel.querySelector('span');
                            if (valueSpan) {
                                valueSpan.textContent = newHeight;
                            }
                        }
                    }
                });

                // Handle height changes
                heightSlider.addEventListener('input', function() {
                    if (maintainAspectCheckbox.checked) {
                        // Calculate new width based on aspect ratio
                        const newWidth = Math.round(this.value * aspectRatio);
                        // Update width slider
                        widthSlider.value = newWidth;
                        // Update displayed value
                        const widthLabel = widthSlider.previousElementSibling;
                        if (widthLabel && widthLabel.tagName === 'LABEL') {
                            const valueSpan = widthLabel.querySelector('span');
                            if (valueSpan) {
                                valueSpan.textContent = newWidth;
                            }
                        }
                    }
                });
            }
        });

        // Initialize star animations for enhance.html
        window.addEventListener('load', function() {
            console.log("Enhance.html - initializing star animations");

            // Try calling createStarsV4 function first (this should work since we're loading script.js)
            if (typeof createStarsV4 === 'function') {
                console.log("Enhance.html - Debug: createStarsV4 function found, calling it");
                createStarsV4();
            } else {
                console.log("Enhance.html - Debug: createStarsV4 function not found!");

                // Set basic styles for background elements
                document.querySelector('.stars').style.opacity = '0.6';
                document.querySelector('.twinkling').style.zIndex = '1';

                // Make sure the app container is above backgrounds
                document.querySelector('.app-container').style.position = 'relative';
                document.querySelector('.app-container').style.zIndex = '10';
            }
        });
    </script>
</body>
</html>