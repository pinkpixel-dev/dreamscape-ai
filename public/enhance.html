<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ú® Dreamscape AI - Image Enhancer & Resizer</title>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Quicksand:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="css/enhance.css">
    <link rel="stylesheet" href="css/cloudinary.css">
    <link rel="icon" type="image/png" href="../favicon.png">
    <!-- Add Cloudinary SDK directly -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/url-polyfill/1.1.12/url-polyfill.min.js"></script>
    <style>
        :root {
            --primary-color: #9d4edd;
            --primary-dark: #7b2cbf;
            --background-dark: #19031b;  
            --background-darker: #0c021b; 
            --text-light: #c8cdf1;
            --text-white: #ffffff;
            --accent-color: #5a2d88;
            --border-color: rgba(157, 78, 221, 0.2);
            --card-bg: rgba(157, 78, 221, 0.05);
            --sidebar-bg: rgba(30, 30, 30, 0.95);
        }
        
        /* Ensure stars background is properly displayed */
        .stars {
            width: 100%;
            height: 100%;
            position: fixed;
            background: transparent url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/stars.png") repeat;
            background-size: 1000px 1000px;
            opacity: 0.6;
            mix-blend-mode: screen;
            z-index: 0;
        }

        .twinkling {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: transparent;
            overflow: hidden;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        .clouds {
            width: 10000px;
            height: 100%;
            position: fixed;
            background: transparent url("https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/clouds_repeat.png") repeat;
            background-size: 4000px 4000px;
            z-index: 2;
            opacity: 0.4;
            animation: move-background 150s linear infinite;
        }

        .input-container textarea {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            resize: vertical;
            font-family: 'Quicksand', sans-serif;
        }

        .input-container textarea:focus {
            border-color: #9d4edd;
            box-shadow: 0 0 20px rgba(157, 78, 221, 0.3);
        }

        .input-container textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Additional styles to fix white backgrounds */
        .image-holder {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3) !important;
            position: relative !important;
        }
        
        /* Create a pseudo-element that ensures the dark background remains */
        .image-holder::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0, 0, 0, 0.3) !important;
            border-radius: 8px !important;
            z-index: 0 !important;
            pointer-events: none !important;
        }
        
        /* Ensure images sit above the pseudo-element background */
        .image-holder img {
            position: relative !important;
            z-index: 1 !important;
            max-width: 100% !important;
            max-height: 400px !important;
            display: block !important;
            margin: 0 auto !important;
            object-fit: contain !important;
            background-color: transparent !important;
        }
        
        /* Also ensure the placeholders stay visible */
        .image-holder .placeholder {
            position: relative !important;
            z-index: 1 !important;
            color: white !important;
        }
        
        /* Fix the result container */
        #result-container {
            display: none;
            margin-top: 20px;
            width: 100%;
        }

        /* Ensure image display containers maintain styles */
        #original-image-display, #enhanced-image-display {
            min-height: 300px !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            overflow: hidden !important;
        }

        /* Critical fixes for the white background issue - these will override any other styles */
        .image-holder {
            background-color: rgba(0, 0, 0, 0.3) !important;
            position: relative !important;
            z-index: 1 !important;
        }
        
        .image-holder::after {
            content: '' !important;
            position: absolute !important;
            inset: 0 !important;
            background-color: rgba(0, 0, 0, 0.3) !important;
            z-index: -1 !important;
            pointer-events: none !important;
        }
        
        .image-holder img {
            background-color: transparent !important;
            position: relative !important;
            z-index: 2 !important;
        }
        
        /* Critical fix for image containers */
        #original-image-display, #enhanced-image-display {
            background-color: rgba(0, 0, 0, 0.3) !important;
        }

        /* Add these rules at the bottom of your style section to overwrite all others */
        .result-container, 
        .image-comparison, 
        .original-image, 
        .enhanced-image {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }

        .original-image h3, 
        .enhanced-image h3 {
            color: white !important;
        }

        .image-holder {
            background-color: rgba(0, 0, 0, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            border-radius: 8px !important;
        }

        .image-holder img {
            background-color: transparent !important;
            max-height: 400px !important;
        }
    </style>
</head>
<body>
    <div class="stars"></div>
    <div class="twinkling"></div>
    <div class="clouds"></div>
    <div class="moon-container">
        <img class="moon-img" src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1231630/moon2.png" alt="moon">
      </div>
      
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="../favicon.png" alt="Dreamscape AI" class="sidebar-logo">
                <span>Creative Studio‚ú®</span>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">üìã Navigation</p>
                <a href="../index.html" class="nav-link">üè† Home</a>
                <a href="enhance.html" class="nav-link active">‚ú® Enhance & Resize Images</a>
                <a href="artistic.html" class="nav-link">üé® Artistic Effects</a>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">‚ú® Enhancement Type</p>
                <div class="control-group">
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="enhancement-type" value="basic" checked>
                            üîß Basic Adjustments
                        </label>
                        <label>
                            <input type="radio" name="enhancement-type" value="auto">
                            ü™Ñ Auto-Enhance
                        </label>
                        <label>
                            <input type="radio" name="enhancement-type" value="advanced">
                            üíé Advanced Quality
                        </label>
                        <label>
                            <input type="radio" name="enhancement-type" value="resize">
                            üìè Resize Image
                        </label>
                    </div>
              </div>
            </div>
            
            <div class="sidebar-section" id="basic-controls">
                <p class="section-title">üñåÔ∏è Basic Adjustments</p>
                <div class="control-group slider-control">
                    <label for="saturation-control">Saturation <span>0</span></label>
                    <input type="range" id="saturation-control" min="-100" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="contrast-control">Contrast <span>0</span></label>
                    <input type="range" id="contrast-control" min="-100" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="brightness-control">Brightness <span>0</span></label>
                    <input type="range" id="brightness-control" min="-100" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="sharpness-control">Sharpness <span>0</span></label>
                    <input type="range" id="sharpness-control" min="0" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="vibrance-control">Vibrance <span>0</span></label>
                    <input type="range" id="vibrance-control" min="0" max="100" value="0">
                </div>
                <div class="control-group slider-control">
                    <label for="gamma-control">Gamma <span>0</span></label>
                    <input type="range" id="gamma-control" min="-50" max="50" value="0">
              </div>
            </div>
            
            <div class="sidebar-section" id="auto-controls" style="display: none;">
                <p class="section-title">ü™Ñ Auto Enhancement</p>
                <div class="control-group">
                    <label for="auto-color">
                        <input type="checkbox" id="auto-color" checked>
                        üåà Auto Color
                    </label>
                </div>
                <div class="control-group">
                    <label for="auto-contrast">
                        <input type="checkbox" id="auto-contrast" checked>
                        üåì Auto Contrast
                    </label>
                </div>
                <div class="control-group">
                    <label for="auto-brightness">
                        <input type="checkbox" id="auto-brightness" checked>
                        ‚òÄÔ∏è Auto Brightness
                    </label>
                </div>
                <div class="control-group">
                    <label for="auto-sharpen">
                        <input type="checkbox" id="auto-sharpen" checked>
                        üîç Auto Sharpen
                    </label>
              </div>
            </div>
            
            <div class="sidebar-section" id="advanced-controls" style="display: none;">
                <p class="section-title">üíé Advanced Quality</p>
                <div class="control-group">
                    <label for="improve">
                        <input type="checkbox" id="improve" checked>
                        ‚ú® Improve (General quality boost)
                    </label>
                </div>
                <div class="control-group">
                    <label for="enhance">
                        <input type="checkbox" id="enhance" checked>
                        üí´ Enhance (Colors & contrast)
                    </label>
              </div>
                <div class="control-group">
                    <label for="quality-auto">
                        <input type="checkbox" id="quality-auto" checked>
                        ‚öôÔ∏è Auto Quality Optimization
                    </label>
            </div>
                <div class="control-group">
                    <label for="format-auto">
                        <input type="checkbox" id="format-auto" checked>
                        üì¶ Auto Format Selection
                    </label>
          </div>
                <div class="control-group slider-control">
                    <label for="unsharp-mask">Unsharp Mask <span>0</span></label>
                    <input type="range" id="unsharp-mask" min="0" max="100" value="0">
        </div>
            </div>
            
            <!-- Add new resize controls section -->
            <div class="sidebar-section" id="resize-controls" style="display: none;">
                <p class="section-title">üìè Resize Settings</p>
                <div class="control-group">
                    <label for="resize-mode">Resize Mode</label>
                    <select id="resize-mode">
                        <option value="scale">Scale (Change dimensions)</option>
                        <option value="fit">Fit (Preserve aspect ratio)</option>
                        <option value="fill">Fill (Cover area, may crop)</option>
                        <option value="pad">Pad (Add padding if needed)</option>
                        <option value="limit">Limit (Down-scale only)</option>
                    </select>
                </div>
                <div class="control-group slider-control">
                    <label for="resize-width">Width <span>800</span>px</label>
                    <input type="range" id="resize-width" min="100" max="2000" value="800">
                </div>
                <div class="control-group slider-control">
                    <label for="resize-height">Height <span>600</span>px</label>
                    <input type="range" id="resize-height" min="100" max="2000" value="600">
                </div>
                <div class="control-group">
                    <label for="resize-maintain-aspect">
                        <input type="checkbox" id="resize-maintain-aspect" checked>
                        üîí Maintain Aspect Ratio
                    </label>
                </div>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">üñºÔ∏è Output Size</p>
                <div class="control-group">
                    <label for="output-size-type">Sizing Method</label>
                    <select id="output-size-type">
                        <option value="original">Original Size</option>
                        <option value="custom" selected>Custom Size</option>
                        <option value="preset">Preset Dimensions</option>
                    </select>
                </div>
                
                <!-- Custom width and height sliders -->
                <div id="custom-size-controls">
                    <div class="control-group slider-control">
                        <label for="width-control">Width <span>768</span>px</label>
                        <input type="range" id="width-control" min="100" max="2000" value="768">
                    </div>
                    <div class="control-group slider-control">
                        <label for="height-control">Height <span>768</span>px</label>
                        <input type="range" id="height-control" min="100" max="2000" value="768">
                    </div>
                    <div class="control-group">
                        <label for="maintain-aspect-ratio">
                            <input type="checkbox" id="maintain-aspect-ratio" checked>
                            üîí Maintain Aspect Ratio
                        </label>
                    </div>
                </div>
                
                <!-- Preset dimensions dropdown, hidden initially if custom is selected -->
                <div id="preset-size-controls" style="display: none;">
                    <div class="control-group">
                        <label for="output-size">Preset Dimensions</label>
                        <select id="output-size">
                            <option value="512x512">512 x 512</option>
                            <option value="768x768" selected>768 x 768</option>
                            <option value="1024x1024">1024 x 1024</option>
                            <option value="1280x720">1280 x 720 (HD)</option>
                            <option value="1920x1080">1920 x 1080 (Full HD)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">üõ†Ô∏è Settings</p>
                <div class="control-group">
                    <label for="remove-watermark">
                        <input type="checkbox" id="remove-watermark" checked>
                        üéØ Remove Watermark
                    </label>
                </div>
                <div class="control-group">
                    <label for="custom-seed">
                        <input type="checkbox" id="custom-seed">
                        üå± Custom Seed
                    </label>
                </div>
                <div class="control-group" id="seed-value-group" style="display: none;">
                    <label for="seed-value">Seed Value</label>
                    <input type="number" id="seed-value" min="1" max="999999" value="42">
            </div>
            </div>
            
            <div class="sidebar-section">
                <p class="section-title">‚ÑπÔ∏è About</p>
                <div class="control-group enhance-description">
                    <p>Enhance your images by choosing from basic adjustments, auto-enhance or advanced quality settings.</p>
                    <p>Your images are processed securely and are not stored on our servers.</p>
            </div>
          </div>
        </div>
        
        <div class="main-content">
            <div class="title-container">
                <div class="title-wrapper">
                    <h1>Image Enhancer & Resizer ‚ú®</h1>
                </div>
                <p class="subtitle-text">Transform and resize your images with powerful tools</p>
            </div>
            
            <div class="content-area">
                <div class="upload-area" id="upload-area">
                    <div id="upload-content">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Upload Image</h3>                    
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="result-container" id="result-container" style="display: none;">
                    <div class="image-comparison">
                        <div class="original-image">
                            <h3>Original Image</h3>
                            <div class="image-holder" id="original-image-display"></div>
                        </div>
                        <div class="enhanced-image">
                            <h3>Enhanced Image</h3>
                            <div class="image-holder" id="enhanced-image-display"></div>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button id="enhance-button" class="action-button">‚ú® Apply Enhancements</button>
                        <button id="download-button" class="action-button" disabled>üíæ Download Result</button>
                        <button id="reset-button" class="action-button">üîÑ Reset</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script src="js/cloudinary-api.js"></script>
    <script>
        // Basic JavaScript for star animation
        function createStars() {
            const container = document.querySelector('.twinkling');
            // Clear any existing stars
            container.innerHTML = '';
            
            // Create 500 stars
            for (let i = 0; i < 500; i++) {
                createTwinklingStar(container);
            }
            
            // Start shooting stars
            createShootingStars(container);
        }

        function createTwinklingStar(container) {
            const star = document.createElement('div');
            star.className = 'star';
            
            // Use a weighted distribution for star sizes
            const random = Math.random();
            if (random < 0.6) {
                star.classList.add('star-1'); // 60% small stars
            } else if (random < 0.8) {
                star.classList.add('star-2'); // 20% medium stars
            } else if (random < 0.95) {
                star.classList.add('star-3'); // 15% large stars
            } else {
                star.classList.add('star-4'); // 5% extra large stars
            }
            
            // Random position
            star.style.top = `${Math.random() * 100}%`;
            star.style.left = `${Math.random() * 100}%`;
            
            // Random animation delay
            star.style.animationDelay = `${Math.random() * 5}s`;
            
            // Random animation duration between 3-8 seconds
            star.style.animationDuration = `${3 + Math.random() * 5}s`;
            
            container.appendChild(star);
            return star;
        }

        function createShootingStars(container) {
            // Create a shooting star every 8 seconds
            setInterval(() => {
                createShootingStar(container);
            }, 8000);
            
            // Create initial shooting star
            createShootingStar(container);
        }

        function createShootingStar(container) {
            const shootingStar = document.createElement('div');
            shootingStar.className = 'shooting-star';
            
            // Random position at the top edge of the screen
            const left = Math.random() * 100;
            shootingStar.style.left = `${left}%`;
            shootingStar.style.top = `${Math.random() * 30}%`;
            
            container.appendChild(shootingStar);
            
            // Remove the shooting star after the animation
            setTimeout(() => {
                shootingStar.remove();
            }, 3000);
        }
        
        // Enhancement type radio buttons
        const enhancementTypes = document.querySelectorAll('input[name="enhancement-type"]');
        const basicControls = document.getElementById('basic-controls');
        const autoControls = document.getElementById('auto-controls');
        const advancedControls = document.getElementById('advanced-controls');
        const resizeControls = document.getElementById('resize-controls');
        
        enhancementTypes.forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide all control sections
                basicControls.style.display = 'none';
                autoControls.style.display = 'none';
                advancedControls.style.display = 'none';
                resizeControls.style.display = 'none';
                
                // Show the selected section
                if (this.value === 'basic') {
                    basicControls.style.display = 'block';
                } else if (this.value === 'auto') {
                    autoControls.style.display = 'block';
                } else if (this.value === 'advanced') {
                    advancedControls.style.display = 'block';
                } else if (this.value === 'resize') {
                    resizeControls.style.display = 'block';
                }
            });
        });

        // Custom seed toggle
        const customSeedCheckbox = document.getElementById('custom-seed');
        const seedValueGroup = document.getElementById('seed-value-group');
        
        customSeedCheckbox.addEventListener('change', function() {
            seedValueGroup.style.display = this.checked ? 'block' : 'none';
        });

        // Update slider value displays
        const sliders = document.querySelectorAll('input[type="range"]');
        sliders.forEach(slider => {
            slider.addEventListener('input', function() {
                const valueDisplay = this.previousElementSibling.querySelector('span');
                valueDisplay.textContent = this.value;
            });
        });
        
        // File upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const resultContainer = document.getElementById('result-container');
        const originalImageDisplay = document.getElementById('original-image-display');
        const enhancedImageDisplay = document.getElementById('enhanced-image-display');
        const enhanceButton = document.getElementById('enhance-button');
        const downloadButton = document.getElementById('download-button');
        const resetButton = document.getElementById('reset-button');
        
        // Variables to store image information
        let uploadedImageInfo = null; // Store the complete Cloudinary upload response
        let transformedImageUrl = '';  // Store the transformed image URL
        
        // Configure the Cloudinary upload widget once
        const uploadWidget = window.cloudinary.createUploadWidget({
            cloudName: 'dwa9nkpyq',
            uploadPreset: 'dreamscape-unsigned',
            apiKey: '887549877845179',
            sources: ['local', 'url', 'camera', 'google_drive', 'facebook', 'dropbox', 'instagram'],
            showAdvancedOptions: false,
            cropping: false,
            multiple: false,
            defaultSource: 'local',
            folder: 'dreamscape-app',
            clientAllowedFormats: ['png', 'jpg', 'jpeg', 'gif', 'webp'],
            maxFileSize: 10000000,
            styles: {
                palette: {
                    window: '#121212',
                    sourceBg: '#121212',
                    windowBorder: '#382f79',
                    tabIcon: '#ffffcc',
                    inactiveTabIcon: '#5e5e5e',
                    menuIcons: '#a76fef',
                    link: '#7046e8',
                    action: '#7046e8',
                    inProgress: '#7046e8',
                    complete: '#a76fef',
                    error: '#ff5a00',
                    textDark: '#eeeeee',
                    textLight: '#121212'
                },
                fonts: {
                    default: null,
                    "sans-serif": { url: null, active: true }
                }
            }
        }, (error, result) => {
            if (error) {
                console.error("Widget error:", error);
                showError('Upload failed: ' + (error.message || "Unknown error"));
                return;
            }
            
            if (result.event === "success") {
                console.log("Upload successful!", result.info);
                
                // Store the complete upload result for later transformation
                uploadedImageInfo = result.info;
                
                // Display the original image in the UI
                const originalUrl = result.info.secure_url;
                originalImageDisplay.innerHTML = `<img src="${originalUrl}" alt="Original Image">`;
                enhancedImageDisplay.innerHTML = `<div class="placeholder">Select enhancement options and click "Apply Enhancements"</div>`;
                
                // Show the result container, hide upload area
                uploadArea.style.display = 'none';
                resultContainer.style.display = 'block';
                
                // Enable the enhance button
                enhanceButton.disabled = false;
            } else if (result.event === "close") {
                // Only show message if nothing was uploaded
                if (!uploadedImageInfo) {
                    console.log("Widget closed without uploading");
                }
            }
        });
        
        // Replace drag-and-drop with direct widget trigger
        uploadArea.addEventListener('click', () => {
            uploadWidget.open();
        });
        
        // Also allow drag-and-drop to open the widget
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            // Instead of handling file directly, just open the widget
            uploadWidget.open();
        });
        
        // Apply enhancements button - now applies to already uploaded image
        enhanceButton.addEventListener('click', async () => {
            console.log("Enhance button clicked");
            
            if (!uploadedImageInfo) {
                showError('Please upload an image first');
                return;
            }
            
            // Disable button while processing
            enhanceButton.disabled = true;
            enhanceButton.textContent = "‚è≥ Processing...";
            
            // Show processing indicator
            enhancedImageDisplay.innerHTML = `
                <div class="placeholder">
                    <p>‚è≥ Applying enhancements...</p>
                    <div class="progress-bar" style="width: 300px; height: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; overflow: hidden; margin: 20px auto;">
                        <div class="progress" style="width: 0%; height: 100%; background: linear-gradient(to right, #7b2cbf, #9d4edd); transition: width 0.5s;"></div>
                    </div>
                </div>
            `;
            
            // Animate progress bar
            const progressBar = enhancedImageDisplay.querySelector('.progress');
            progressBar.style.width = '30%';
            
            try {
                // Build transformation parameters based on selected options
                const enhancementType = document.querySelector('input[name="enhancement-type"]:checked').value;
                const transformations = [];
                
                // Get the original public ID from the uploaded image
                const publicId = uploadedImageInfo.public_id;
                const format = uploadedImageInfo.format;
                
                // Add size transformation based on selected sizing method
                const sizeType = document.getElementById('output-size-type').value;
                
                if (sizeType === 'custom') {
                    // Use custom width and height from sliders
                    const width = document.getElementById('width-control').value;
                    const height = document.getElementById('height-control').value;
                    transformations.push(`c_scale,w_${width},h_${height}`);
                } 
                else if (sizeType === 'preset') {
                    // Use preset dimensions from dropdown
                    const outputSize = document.getElementById('output-size').value;
                    if (outputSize) {
                        const [width, height] = outputSize.split('x');
                        transformations.push(`c_scale,w_${width},h_${height}`);
                    }
                }
                // If original is selected, don't add any size transformation
                
                // Add enhancements based on type
                if (enhancementType === 'basic') {
                    const saturation = parseInt(document.getElementById('saturation-control').value);
                    if (saturation !== 0) transformations.push(`e_saturation:${saturation}`);
                    
                    const contrast = parseInt(document.getElementById('contrast-control').value);
                    if (contrast !== 0) transformations.push(`e_contrast:${contrast}`);
                    
                    const brightness = parseInt(document.getElementById('brightness-control').value);
                    if (brightness !== 0) transformations.push(`e_brightness:${brightness}`);
                    
                    const sharpness = parseInt(document.getElementById('sharpness-control').value);
                    if (sharpness > 0) transformations.push(`e_sharpen:${sharpness}`);
                } 
                else if (enhancementType === 'auto') {
                    if (document.getElementById('auto-contrast').checked) {
                        transformations.push(`e_auto_contrast`);
                    }
                    if (document.getElementById('auto-color').checked) {
                        transformations.push(`e_auto_color`);
                    }
                }
                else if (enhancementType === 'advanced') {
                    if (document.getElementById('quality-auto').checked) {
                        transformations.push(`q_auto`);
                    }
                    if (document.getElementById('improve').checked) {
                        transformations.push(`e_improve`);
                    }
                    if (document.getElementById('enhance').checked) {
                        transformations.push(`e_enhance`);
                    }
                }
                else if (enhancementType === 'resize') {
                    // Get resize dimensions and mode
                    const width = document.getElementById('resize-width').value;
                    const height = document.getElementById('resize-height').value;
                    const resizeMode = document.getElementById('resize-mode').value;
                    
                    // Add resize transformation based on selected mode
                    switch(resizeMode) {
                        case 'scale':
                            transformations.push(`c_scale,w_${width},h_${height}`);
                            break;
                        case 'fit':
                            transformations.push(`c_fit,w_${width},h_${height}`);
                            break;
                        case 'fill':
                            transformations.push(`c_fill,w_${width},h_${height},g_auto`);
                            break;
                        case 'pad':
                            transformations.push(`c_pad,w_${width},h_${height}`);
                            break;
                        case 'limit':
                            transformations.push(`c_limit,w_${width},h_${height}`);
                            break;
                        default:
                            transformations.push(`c_scale,w_${width},h_${height}`);
                    }
                }
                
                // Update progress bar
                progressBar.style.width = '60%';
                
                // Create the transformation URL
                let transformationString = transformations.join('/');
                if (!transformationString) transformationString = 'c_scale,w_800';
                
                // Final transformation URL using Cloudinary's format
                transformedImageUrl = `https://res.cloudinary.com/dwa9nkpyq/image/upload/${transformationString}/${publicId}.${format}`;
                console.log("Generated transformation URL:", transformedImageUrl);
                
                // Update progress bar
                progressBar.style.width = '80%';
                
                // Display the transformed image
                enhancedImageDisplay.innerHTML = `
                    <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <img 
                            id="enhanced-image"
                            src="${transformedImageUrl}" 
                            style="max-width: 100%; max-height: 350px; object-fit: contain;" 
                            alt="Enhanced Image"
                            onload="this.style.opacity = '1';"
                            onerror="document.getElementById('enhancement-error').style.display = 'block'; this.style.display = 'none';"
                        />
                        <div id="enhancement-error" style="display: none; color: #ff5555; text-align: center; margin-top: 20px;">
                            <p>Error loading the enhanced image.</p>
                            <button id="simple-transform-btn" style="padding: 8px 12px; background: #7b2cbf; border: none; color: white; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Try Simple Transformation
                            </button>
                        </div>
                        <p style="color: #4CAF50; margin-top: 15px; text-align: center;">‚ú® Enhancement complete!</p>
                    </div>
                `;
                
                // Add error handler for the simple transform button
                document.getElementById('enhancement-error')?.addEventListener('click', (e) => {
                    if (e.target.id === 'simple-transform-btn') {
                        // Create a much simpler URL with just basic transformations
                        const simpleUrl = `https://res.cloudinary.com/dwa9nkpyq/image/upload/c_scale,w_800/${publicId}.${format}`;
                        transformedImageUrl = simpleUrl;
                        enhancedImageDisplay.innerHTML = `
                            <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <img 
                                    src="${simpleUrl}" 
                                    style="max-width: 100%; max-height: 350px; object-fit: contain;" 
                                    alt="Enhanced Image (Simple)"
                                />
                                <p style="color: #FFD700; margin-top: 15px; text-align: center;">‚ö†Ô∏è Using simplified enhancement</p>
                            </div>
                        `;
                        downloadButton.disabled = false;
                    }
                });
                
                // Enable download button
                downloadButton.disabled = false;
                
            } catch (error) {
                console.error("Enhancement error:", error);
                enhancedImageDisplay.innerHTML = `
                    <div class="placeholder">
                        <p style="color: #ff5555;">Error applying enhancements</p>
                        <p>${error.message || "Unknown error"}</p>
                    </div>
                `;
            } finally {
                // Restore enhance button state
                enhanceButton.disabled = false;
                enhanceButton.textContent = "‚ú® Apply Enhancements";
            }
        });
        
        // Download button - opens the image in a new tab
        downloadButton.addEventListener('click', () => {
            if (transformedImageUrl) {
                window.open(transformedImageUrl, '_blank');
            }
        });
        
        // Reset button
        resetButton.addEventListener('click', () => {
            // Reset to upload state
            uploadArea.style.display = 'block';
            resultContainer.style.display = 'none';
            
            // Reset Cloudinary data
            uploadedImageInfo = null;
            transformedImageUrl = '';
            
            // Reset sliders
            sliders.forEach(slider => {
                slider.value = slider.defaultValue;
                const valueDisplay = slider.previousElementSibling.querySelector('span');
                valueDisplay.textContent = slider.defaultValue;
            });
            
            // Reset checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = checkbox.defaultChecked;
            });
            
            // Reset to basic enhancement
            document.querySelector('input[name="enhancement-type"][value="basic"]').checked = true;
            basicControls.style.display = 'block';
            autoControls.style.display = 'none';
            advancedControls.style.display = 'none';
            resizeControls.style.display = 'none';
            
            // Hide seed value input
            seedValueGroup.style.display = 'none';
        });
        
        // Helper function to show error messages
        function showError(message) {
            // Display the error in the UI
            const errorToast = document.createElement('div');
            errorToast.className = 'error-toast';
            errorToast.innerHTML = `<p>${message}</p>`;
            errorToast.style.position = 'fixed';
            errorToast.style.bottom = '20px';
            errorToast.style.left = '50%';
            errorToast.style.transform = 'translateX(-50%)';
            errorToast.style.backgroundColor = 'rgba(255, 50, 50, 0.9)';
            errorToast.style.color = 'white';
            errorToast.style.padding = '10px 20px';
            errorToast.style.borderRadius = '5px';
            errorToast.style.zIndex = '1000';
            
            document.body.appendChild(errorToast);
            
            // Remove after 5 seconds
            setTimeout(() => {
                errorToast.style.opacity = '0';
                errorToast.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(errorToast);
                }, 500);
            }, 5000);
        }
        
        // Initialize stars
        document.addEventListener('DOMContentLoaded', () => {
            createStars();
            
            // Setup size controls interaction
            const sizeTypeSelector = document.getElementById('output-size-type');
            const customSizeControls = document.getElementById('custom-size-controls');
            const presetSizeControls = document.getElementById('preset-size-controls');
            
            sizeTypeSelector.addEventListener('change', function() {
                if (this.value === 'custom') {
                    customSizeControls.style.display = 'block';
                    presetSizeControls.style.display = 'none';
                } else if (this.value === 'preset') {
                    customSizeControls.style.display = 'none';
                    presetSizeControls.style.display = 'block';
                } else {
                    // Original size
                    customSizeControls.style.display = 'none';
                    presetSizeControls.style.display = 'none';
                }
            });
            
            // Setup aspect ratio maintenance
            const widthSlider = document.getElementById('width-control');
            const heightSlider = document.getElementById('height-control');
            const aspectRatioCheckbox = document.getElementById('maintain-aspect-ratio');
            
            let aspectRatio = 1; // Default square
            let isUpdatingWidth = false;
            let isUpdatingHeight = false;
            
            // Set initial aspect ratio from the original image once uploaded
            const updateAspectRatioFromImage = () => {
                if (uploadedImageInfo && uploadedImageInfo.width && uploadedImageInfo.height) {
                    aspectRatio = uploadedImageInfo.width / uploadedImageInfo.height;
                    console.log(`Set aspect ratio to ${aspectRatio} from original image`);
                }
            };
            
            // Width change handler
            widthSlider.addEventListener('input', function() {
                if (isUpdatingWidth) return; // Prevent recursion
                
                const width = parseInt(this.value);
                widthSlider.previousElementSibling.querySelector('span').textContent = width;
                
                // Update height based on aspect ratio if checkbox is checked
                if (aspectRatioCheckbox.checked && !isUpdatingHeight) {
                    isUpdatingHeight = true;
                    const newHeight = Math.round(width / aspectRatio);
                    
                    // Ensure height is within valid range
                    const constrainedHeight = Math.min(Math.max(newHeight, 100), 2000);
                    heightSlider.value = constrainedHeight;
                    heightSlider.previousElementSibling.querySelector('span').textContent = constrainedHeight;
                    isUpdatingHeight = false;
                }
            });
            
            // Height change handler
            heightSlider.addEventListener('input', function() {
                if (isUpdatingHeight) return; // Prevent recursion
                
                const height = parseInt(this.value);
                heightSlider.previousElementSibling.querySelector('span').textContent = height;
                
                // Update width based on aspect ratio if checkbox is checked
                if (aspectRatioCheckbox.checked && !isUpdatingWidth) {
                    isUpdatingWidth = true;
                    const newWidth = Math.round(height * aspectRatio);
                    
                    // Ensure width is within valid range
                    const constrainedWidth = Math.min(Math.max(newWidth, 100), 2000);
                    widthSlider.value = constrainedWidth;
                    widthSlider.previousElementSibling.querySelector('span').textContent = constrainedWidth;
                    isUpdatingWidth = false;
                }
            });
            
            // Update aspect ratio when image is uploaded
            const originalInterval = setInterval(() => {
                if (uploadedImageInfo) {
                    updateAspectRatioFromImage();
                    clearInterval(originalInterval);
                }
            }, 500);

            // Setup resize functionality
            const resizeWidth = document.getElementById('resize-width');
            const resizeHeight = document.getElementById('resize-height');
            const resizeMaintainAspect = document.getElementById('resize-maintain-aspect');
            
            let resizeAspectRatio = 1; // Default square
            let isUpdatingResizeWidth = false;
            let isUpdatingResizeHeight = false;
            
            // Set initial resize dimensions from the original image once uploaded
            const updateResizeDimensionsFromImage = () => {
                if (uploadedImageInfo && uploadedImageInfo.width && uploadedImageInfo.height) {
                    resizeAspectRatio = uploadedImageInfo.width / uploadedImageInfo.height;
                    
                    // Update resize controls with original image dimensions
                    resizeWidth.value = Math.min(uploadedImageInfo.width, 2000);
                    resizeHeight.value = Math.min(uploadedImageInfo.height, 2000);
                    
                    // Update display values
                    resizeWidth.previousElementSibling.querySelector('span').textContent = resizeWidth.value;
                    resizeHeight.previousElementSibling.querySelector('span').textContent = resizeHeight.value;
                    
                    console.log(`Set resize aspect ratio to ${resizeAspectRatio} from original image`);
                }
            };
            
            // Width change handler for resize
            resizeWidth.addEventListener('input', function() {
                if (isUpdatingResizeWidth) return; // Prevent recursion
                
                const width = parseInt(this.value);
                this.previousElementSibling.querySelector('span').textContent = width;
                
                // Update height based on aspect ratio if checkbox is checked
                if (resizeMaintainAspect.checked && !isUpdatingResizeHeight) {
                    isUpdatingResizeHeight = true;
                    const newHeight = Math.round(width / resizeAspectRatio);
                    
                    // Ensure height is within valid range
                    const constrainedHeight = Math.min(Math.max(newHeight, 100), 2000);
                    resizeHeight.value = constrainedHeight;
                    resizeHeight.previousElementSibling.querySelector('span').textContent = constrainedHeight;
                    isUpdatingResizeHeight = false;
                }
            });
            
            // Height change handler for resize
            resizeHeight.addEventListener('input', function() {
                if (isUpdatingResizeHeight) return; // Prevent recursion
                
                const height = parseInt(this.value);
                this.previousElementSibling.querySelector('span').textContent = height;
                
                // Update width based on aspect ratio if checkbox is checked
                if (resizeMaintainAspect.checked && !isUpdatingResizeWidth) {
                    isUpdatingResizeWidth = true;
                    const newWidth = Math.round(height * resizeAspectRatio);
                    
                    // Ensure width is within valid range
                    const constrainedWidth = Math.min(Math.max(newWidth, 100), 2000);
                    resizeWidth.value = constrainedWidth;
                    resizeWidth.previousElementSibling.querySelector('span').textContent = constrainedWidth;
                    isUpdatingResizeWidth = false;
                }
            });
            
            // Update aspect ratio when image is uploaded
            const resizeInterval = setInterval(() => {
                if (uploadedImageInfo) {
                    updateAspectRatioFromImage();
                    updateResizeDimensionsFromImage();
                    clearInterval(resizeInterval);
                }
            }, 500);
        });
    </script>
</body>
</html>